<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AskCampus | Campus Portal</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. THEME & VARIABLES --- */
        :root {
            /* Pure Green Palette */
            --bg-gradient-start: #1a2310;
            --bg-gradient-mid: #2d3623;
            --bg-gradient-end: #0f140a;
            
            --olive-mid: #3a4b24;
            --olive-pastel: #b8c5a8; 
            --olive-light: #d9e0d0;
            
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --danger-color: #ff6b6b;
            
            --primary-color: var(--olive-pastel);
            --btn-text-color: #2d3623;
            --text-color: #f0f0f0;
            --text-muted: rgba(255, 255, 255, 0.7);
            
            /* Blob Colors for Green Theme */
            --blob-color-1: #3a4b24;
            --blob-color-2: #556b2f;
            --blob-color-3: #4a6b4b;
        }

        /* Black & White Theme Override */
        body.theme-bw {
            --bg-gradient-start: #000000;
            --bg-gradient-mid: #1a1a1a;
            --bg-gradient-end: #0d0d0d;
            
            --olive-mid: #333333;
            --olive-pastel: #ffffff;
            --olive-light: #cccccc;
            
            --primary-color: #ffffff;
            --btn-text-color: #000000;
            
            --blob-color-1: #333333;
            --blob-color-2: #111111;
            --blob-color-3: #444444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            height: 100vh;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            overflow: hidden;
            color: var(--text-color);
            transition: background 0.5s ease;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- 2. ANIMATED BACKGROUND ELEMENTS --- */
        .background-blobs {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
            pointer-events: none;
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: float 25s infinite ease-in-out;
            transition: background 0.5s ease;
        }

        .blob-1 { width: 600px; height: 600px; background: var(--blob-color-1); top: -20%; left: -10%; animation-delay: 0s; opacity: 0.3; }
        .blob-2 { width: 500px; height: 500px; background: var(--blob-color-2); bottom: -10%; right: -10%; animation-delay: -5s; opacity: 0.3; }
        .blob-3 { width: 400px; height: 400px; background: var(--blob-color-3); top: 40%; left: 30%; filter: blur(90px); opacity: 0.2; animation: float 30s infinite reverse; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0, 0) scale(1); }
        }

        /* --- 3. RESPONSIVE GLASS CARD --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            width: 90%;
            max-width: 440px;
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            z-index: 10;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* View specific states */
        .glass-card.disclaimer-active { max-width: 400px; }
        .glass-card.auth-active { max-width: 440px; }
        .glass-card.chat-active { max-width: 600px; height: 80vh; padding: 0; }

        @media (max-width: 768px) {
            .glass-card {
                width: 100%; height: 100dvh; max-width: none !important;
                border-radius: 0; border: none; padding: 25px;
                justify-content: center;
                background: rgba(26, 35, 16, 0.6);
            }
            .glass-card.chat-active { justify-content: flex-start; padding: 0; }
            .otp-inputs { gap: 5px; }
            .otp-field { width: 40px; height: 50px; font-size: 1.2rem; }
            #chat-messages { padding: 15px; }
            .chat-footer { padding: 15px; }
            .chat-header { padding: 15px 20px; }
        }

        /* --- 4. TYPOGRAPHY --- */
        .logo h1 { font-size: 2.2rem; letter-spacing: -1px; margin-bottom: 5px; font-weight: 600; text-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .logo h1 span { color: var(--primary-color); }
        .subtitle { font-weight: 300; font-size: 0.85rem; opacity: 0.7; margin-bottom: 0; display: block; }

        /* --- 5. AUTH COMPONENTS --- */
        #login-form {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 15px;
            margin-top: 30px;
        }

        .theme-switcher {
            position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; z-index: 20;
        }
        .theme-btn {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer; transition: transform 0.2s;
        }
        .theme-btn:hover { transform: scale(1.2); }
        .theme-btn.green { background: #b8c5a8; }
        .theme-btn.bw { background: #ffffff; border-color: #555; }

        input[type="email"] {
            width: 100%; padding: 16px; background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border); border-radius: 15px; color: white; font-size: 1rem; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary-color); background: rgba(255, 255, 255, 0.1); box-shadow: 0 0 15px rgba(255,255,255,0.1); }

        .otp-container { display: none; animation: fadeIn 0.5s ease; }
        .otp-inputs { display: flex; justify-content: space-between; gap: 8px; margin-top: 5px; }
        .otp-field {
            width: 45px; height: 55px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border);
            border-radius: 12px; text-align: center; font-size: 1.4rem; color: white; font-weight: 600; outline: none; transition: all 0.2s;
        }
        .otp-field:focus { border-color: var(--primary-color); background: rgba(255, 255, 255, 0.2); box-shadow: 0 0 10px rgba(255,255,255,0.1); }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 15px; font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; justify-content: center;
            margin: 0;
        }
        .btn-primary { background: var(--primary-color); color: var(--btn-text-color); }
        .btn-primary:hover:not(:disabled) { background: var(--olive-light); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(184, 197, 168, 0.2); }
        .btn:disabled { opacity: 0.6; cursor: wait; }
        
        .btn-secondary { 
            background: transparent; 
            border: 1px solid var(--glass-border); 
            color: var(--text-muted); 
            font-size: 0.9rem;
            padding: 12px;
        }
        .btn-secondary:hover { 
            background: rgba(255, 255, 255, 0.05); 
            color: white; 
            border-color: var(--primary-color); 
        }

        .spinner {
            width: 20px; height: 20px; border: 3px solid rgba(45, 54, 35, 0.3); border-radius: 50%; border-top-color: #2d3623;
            animation: spin 0.8s linear infinite; display: none; margin-left: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .error-msg { color: var(--danger-color); font-size: 0.8rem; display: none; text-align: left; padding-left: 5px; }

        /* --- 6. CHAT UI --- */
        #chat-view { display: none; opacity: 0; flex-direction: column; height: 100%; width: 100%; transition: opacity 0.4s ease; position: relative; }
        
        .chat-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 25px; border-bottom: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.02);
        }
        .chat-title { font-size: 1.1rem; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; background: var(--primary-color); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--primary-color); animation: breathe 3s infinite; }
        
        @keyframes breathe { 0%, 100% { opacity: 0.5; box-shadow: 0 0 5px var(--primary-color); } 50% { opacity: 1; box-shadow: 0 0 15px var(--primary-color); } }

        .settings-btn { background: none; border: none; color: white; opacity: 0.7; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }
        .settings-btn:hover { opacity: 1; transform: rotate(90deg); color: var(--primary-color); }

        #chat-messages {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            scroll-behavior: smooth;
        }
        #chat-messages::-webkit-scrollbar { width: 5px; }
        #chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .msg { max-width: 80%; padding: 14px 18px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; position: relative; animation: slideIn 0.3s ease forwards; opacity: 0; transform: translateY(10px); }
        .msg.bot { background: rgba(255, 255, 255, 0.08); align-self: flex-start; border-bottom-left-radius: 4px; color: var(--text-color); }
        .msg.user { background: var(--primary-color); color: var(--btn-text-color); align-self: flex-end; border-bottom-right-radius: 4px; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }

        .chat-footer {
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--glass-border);
            display: flex; gap: 10px; align-items: center;
        }

        .input-wrapper {
            flex: 1; position: relative;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            backdrop-filter: blur(15px);
            transition: 0.3s;
            display: flex; align-items: center;
            padding: 5px 5px 5px 20px;
        }
        .input-wrapper:focus-within { border-color: var(--primary-color); box-shadow: 0 0 15px rgba(255,255,255,0.1); background: var(--glass-highlight); }

        .chat-input {
            width: 100%; background: transparent; border: none; color: white; font-size: 1rem; outline: none; padding: 10px 0;
        }
        .chat-input::placeholder { color: rgba(255, 255, 255, 0.4); }

        .send-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: var(--primary-color); color: var(--btn-text-color);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.3s; flex-shrink: 0;
        }
        .send-btn:hover { transform: scale(1.05); background: var(--olive-light); }
        .send-btn:active { transform: scale(0.95); }

        .typing { font-size: 0.75rem; opacity: 0.6; margin: -10px 0 10px 20px; text-align: left; height: 1rem; display: flex; align-items: center; gap: 5px; }
        .dot { width: 4px; height: 4px; background: white; border-radius: 50%; animation: pulse 1s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        /* Notification */
        .notification {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--olive-light); color: #2d3623; padding: 12px 20px;
            border-radius: 12px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100; display: none; animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* View State Management */
        #auth-view {
            display: none;
            opacity: 0;
            flex-direction: column;
            width: 100%;
            justify-content: center;
            align-items: center;
            transition: opacity 0.4s ease;
        }
        
        #disclaimer-view {
            display: flex;
            flex-direction: column;
            width: 100%;
            justify-content: center;
            align-items: center;
            transition: opacity 0.4s ease;
        }

        /* --- 7. MODALS --- */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; }

        .glass-modal {
            background: rgba(26, 35, 16, 0.95);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 85%;
            max-width: 320px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .glass-modal { transform: scale(1); }
        
        body.theme-bw .glass-modal { background: rgba(0, 0, 0, 0.95); }

        .glass-modal h3 { font-weight: 600; margin-bottom: 20px; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .glass-modal p { font-size: 0.9rem; opacity: 0.8; margin-bottom: 25px; color: #d0d0d0; }
        
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .modal-actions button { 
            margin-top: 0; padding: 12px 20px; font-size: 0.9rem; border-radius: 12px; flex: 1;
        }
        
        /* Modal Buttons */
        .modal-btn-option {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 12px;
            justify-content: flex-start;
            padding-left: 20px;
            font-weight: 500;
            width: 100%;
            display: flex;
            align-items: center;
        }
        .modal-btn-option:hover { background: rgba(255, 255, 255, 0.15); border-color: rgba(255,255,255,0.3); }
        .modal-btn-option i { margin-right: 15px; width: 20px; text-align: center; }

        .modal-btn-cancel { 
            background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; 
        }
        .modal-btn-cancel:hover { background: rgba(255,255,255,0.1); }
        
        .modal-btn-confirm { 
            background: var(--danger-color); border: none; color: white; box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        .modal-btn-confirm:hover { background: #ff5252; transform: translateY(-2px); }

        /* Report Textarea */
        textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            color: white;
            font-family: 'Poppins', sans-serif;
            outline: none;
            resize: none;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        textarea:focus { border-color: var(--primary-color); background: rgba(0, 0, 0, 0.4); }

    </style>
</head>
<body>
    
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- NOTIFICATION -->
    <div id="demo-notification" class="notification"></div>

    <div class="glass-card disclaimer-active" id="main-card">
        
        <!-- === DISCLAIMER VIEW === -->
        <div id="disclaimer-view">
            <div class="logo"><h1>WARNING</h1></div>
            <div style="margin: 20px 0; color: var(--danger-color); font-size: 1.1rem; font-weight: 600;">
                <i class="fa-solid fa-triangle-exclamation" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
                THE AI IS NOT TRAINED WELL AND IT MAY SHOW FALSE RESULT
            </div>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 30px; line-height: 1.5;">
                Please verify important academic and administrative information directly with the college office.
            </p>
            <button class="btn btn-primary" onclick="acceptDisclaimer()">OKAY</button>
        </div>

        <!-- === AUTH VIEW === -->
        <div id="auth-view">
            <!-- Theme Switcher -->
            <div class="theme-switcher">
                <button class="theme-btn green" onclick="setTheme('green')" title="Green Theme"></button>
                <button class="theme-btn bw" onclick="setTheme('bw')" title="Black & White"></button>
            </div>

            <div class="logo"><h1>Ask<span>Campus</span></h1><span class="subtitle">Campus Portal Login</span></div>
            <div id="login-form">
                <input type="email" id="email" placeholder="College Email (@vjcet.org)" required>
                <div id="error-msg" class="error-msg"></div>

                <div id="otp-section" class="otp-container">
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 8px;">Check your email for the 6-digit code</p>
                    <div class="otp-inputs">
                        <input type="text" maxlength="1" class="otp-field" inputmode="numeric">
                        <input type="text" maxlength="1" class="otp-field" inputmode="numeric">
                        <input type="text" maxlength="1" class="otp-field" inputmode="numeric">
                        <input type="text" maxlength="1" class="otp-field" inputmode="numeric">
                        <input type="text" maxlength="1" class="otp-field" inputmode="numeric">
                        <input type="text" maxlength="1" class="otp-field" inputmode="numeric">
                    </div>
                </div>
                
                <button class="btn btn-primary" id="btn-action" onclick="handleAuthAction()">
                    <span id="btn-text">Send Verification Code</span>
                    <div class="spinner" id="btn-spinner"></div>
                </button>

                <button class="btn btn-secondary" id="btn-guest" onclick="handleGuestLogin()">
                    Continue as Visitor
                </button>
            </div>
        </div>

        <!-- === CHAT VIEW (NEW HOME) === -->
        <div id="chat-view">
            <div class="chat-header">
                <div class="chat-title" id="header-title">
                    <span class="status-dot"></span>
                    AskCampus AI
                </div>
                <button class="settings-btn" onclick="toggleSettings()"><i class="fa-solid fa-gear"></i></button>
            </div>

            <div id="chat-messages">
                <div class="msg bot">Hello! I'm your virtual Vjcet campus assistant. How can I help you today?</div>
            </div>
            
            <div id="typing-indicator" class="typing" style="display: none;">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>

            <div class="chat-footer">
                <div class="input-wrapper">
                    <input type="text" id="chat-input" class="chat-input" placeholder="Type your query..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- === SETTINGS MODAL === -->
        <div id="settings-modal" class="modal-overlay">
            <div class="glass-modal">
                <h3>Settings</h3>
                <button class="btn modal-btn-option" onclick="openReportModal()">
                    <i class="fa-solid fa-triangle-exclamation"></i> Report Issue
                </button>
                <button class="btn modal-btn-option" onclick="triggerLogoutConfirmation()" style="border-color: rgba(255, 107, 107, 0.5); color: #ff6b6b;">
                    <i class="fa-solid fa-right-from-bracket"></i> Log Out
                </button>
                <button class="btn modal-btn-cancel" onclick="closeSettingsModal()" style="margin-top: 15px; font-size: 0.8rem;">Close</button>
            </div>
        </div>

        <!-- === REPORT MODAL === -->
        <div id="report-modal" class="modal-overlay">
            <div class="glass-modal">
                <h3>Report Issue</h3>
                <textarea id="report-text" rows="4" placeholder="Describe the issue you are facing..."></textarea>
                <div class="modal-actions">
                    <button class="btn modal-btn-cancel" onclick="closeReportModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitReport()">Submit</button>
                </div>
            </div>
        </div>

        <!-- === LOGOUT CONFIRMATION MODAL === -->
        <div id="logout-modal" class="modal-overlay">
            <div class="glass-modal">
                <h3>Log Out?</h3>
                <p>Are you sure you want to end your session?</p>
                <div class="modal-actions">
                    <button class="btn modal-btn-cancel" onclick="closeLogoutModal()">Cancel</button>
                    <button class="btn modal-btn-confirm" onclick="confirmLogout()">Log Out</button>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATIONS ---
        const emailJsConfig = {
            serviceID: "service_ztras7a",
            templateID: "template_schdxfl", 
            publicKey: "6CkOb9c2S-J3aFH5l"
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDIECIqWkrLVexHmnTjUV3CATw7h2i38Uc",
            authDomain: "askcampus-ea173.firebaseapp.com",
            projectId: "askcampus-ea173",
            storageBucket: "askcampus-ea173.firebasestorage.app",
            messagingSenderId: "834755037776",
            appId: "1:834755037776:web:89624d21c98d98909b9f55",
            measurementId: "G-RDJZV2XR2K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const apiKey = "AIzaSyCl8a7_zsSeDrT1eoaZgVo5flacJw7sxVo"; // Gemini API Key

        try { emailjs.init(emailJsConfig.publicKey); } catch(e) { console.log("EmailJS init failed"); }

        let currentOTP = null;
        let isOtpSent = false;
        let isDisclaimerAccepted = false;
        let currentUser = null;

        // --- THEME SWITCHER ---
        window.setTheme = (theme) => {
            if (theme === 'bw') {
                document.body.classList.add('theme-bw');
            } else {
                document.body.classList.remove('theme-bw');
            }
        };

        // --- HELPER: NAME EXTRACTION ---
        function extractName(email) {
            if (!email || email.includes("Visitor")) return "Visitor";
            const localPart = email.split('@')[0];
            const match = localPart.match(/^[a-zA-Z]+/);
            if (match && match[0]) {
                return match[0].charAt(0).toUpperCase() + match[0].slice(1);
            }
            return "Scholar";
        }

        // --- HELPER: TIME GREETING ---
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Good Morning";
            if (hour < 17) return "Good Afternoon";
            return "Good Evening";
        }

        // --- PRIVATE STUDENT DATA ---
        const specificStudentData = {
            "attendance_with_duty_leave": [
                { "subject": "Operating Systems", "attended": 17, "total": 20, "percentage": 85 },
                { "subject": "Computer Organization and Architecture", "attended": 15, "total": 17, "percentage": 88 },
                { "subject": "Engineering Ethics and Sustainable Development", "attended": 4, "total": 4, "percentage": 100 },
                { "subject": "DBMS Lab", "attended": 12, "total": 12, "percentage": 100 },
                { "subject": "Operating Systems Lab", "attended": 9, "total": 9, "percentage": 100 },
                { "subject": "Aptitude Training – Phase 2", "attended": 3, "total": 4, "percentage": 75 },
                { "subject": "Mentoring", "attended": 2, "total": 2, "percentage": 100 },
                { "subject": "Software Engineering", "attended": 12, "total": 13, "percentage": 92 },
                { "subject": "Mathematics for Computer and Information Science – 4", "attended": 12, "total": 14, "percentage": 86 },
                { "subject": "Database Management Systems", "attended": 14, "total": 14, "percentage": 100 }
            ],
            "attendance_without_duty_leave": [
                { "subject": "Operating Systems", "attended": 15, "total": 20, "percentage": 75 },
                { "subject": "Computer Organization and Architecture", "attended": 13, "total": 17, "percentage": 76 },
                { "subject": "Engineering Ethics and Sustainable Development", "attended": 3, "total": 4, "percentage": 75 },
                { "subject": "DBMS Lab", "attended": 12, "total": 12, "percentage": 100 },
                { "subject": "Operating Systems Lab", "attended": 3, "total": 9, "percentage": 33 },
                { "subject": "Aptitude Training – Phase 2", "attended": 3, "total": 4, "percentage": 75 },
                { "subject": "Mentoring", "attended": 2, "total": 2, "percentage": 100 },
                { "subject": "Software Engineering", "attended": 10, "total": 13, "percentage": 77 },
                { "subject": "Mathematics for Computer and Information Science – 4", "attended": 8, "total": 14, "percentage": 57 }
            ],
            "semester_results_2024_12_01-": {
                "credits_earned": 10,
                "total_credits": 20,
                "sgpa": 3.05,
                "cgpa_upto_semester": 4.98,
                "status": "FAILED",
                "subjects": [
                    { "code": "GAMAT101", "name": "Mathematics for Information Science – 1", "attendance": 96, "credits": 0, "grade": "F" },
                    { "code": "GAPHT121", "name": "Physics for Information Science", "attendance": 97, "credits": 4, "grade": "O" },
                    { "code": "GMEST103", "name": "Engineering Graphics and Computer Aided Drawing", "attendance": 88, "credits": 0, "grade": "F" },
                    { "code": "GXEST104", "name": "Introduction to Electrical & Electronics Engineering", "attendance": 97, "credits": 0, "grade": "F" },
                    { "code": "UCEST105", "name": "Algorithmic Thinking with Python", "attendance": 100, "credits": 4, "grade": "C" },
                    { "code": "GXESL106", "name": "Basic Electrical and Electronics Engineering Workshop", "attendance": 100, "credits": 1, "grade": "B+" },
                    { "code": "UCHUT128", "name": "Life Skills and Professional Communication", "attendance": 100, "credits": 1, "grade": "PASS" }
                ]
            }
        };

        // --- KNOWLEDGE BASE (FIXED: Added missing commas) ---
        const collegeKnowledgeBase = {
            "about": "Viswajyothi College of Engineering and Technology (VJCET) is a self-financing engineering college established in 2001, managed by the Diocesan Technical Education Trust, Kothamangalam. The campus is located in Vazhakulam, Muvattupuzha.",

            "location": "VJCET is situated in Vazhakulam, Muvattupuzha, Ernakulam District, Kerala, India. The region is popularly known as 'Pineapple City'.",

            "affiliation": "The college is affiliated to APJ Abdul Kalam Technological University (KTU) and approved by AICTE, New Delhi. It is accredited by NAAC with 'A' Grade.",

            "courses": "VJCET offers B.Tech programs in CSE, ECE, EEE, ME, CE, IT, AI & DS, and CSE (Cyber Security). It also offers M.Tech programs and an MBA.",

            "working_hours": "College working hours are from 8:55 AM to 4:15 PM on working days.",

            "attendance": "A minimum of 75% attendance is required to be eligible for semester examinations.",

            "attendance_shortage": "Students with attendance below 75% are not allowed to write exams. However, condonation may be permitted as per university norms.",

            "exam": "Semester examinations are conducted by KTU. Internal (series) examinations are conducted by the college.",

            "leave_policy": "Medical leave and duty leave are permitted with valid proof as per college rules.",

            "first_year": "First-year classes are conducted in separate department blocks. First-year students follow the same rules as other students.",

            "first_year_privileges": "First-year students are allowed to join clubs, participate in arts and technical fests, use college buses, and access the canteen.",

            "erp": "Students use the ETLAB software for attendance, internal marks, and academic updates.",

            "mentoring": "Each class is assigned tutors and assistant tutors for academic guidance and student support.",

            "counselling": "The college provides counselling and mental health support services for students.",

            "scholarship": "Scholarship support is available. Students should contact the college office for details on applicable schemes.",

            "placement_start": "Placement training and support start from the first year itself.",

            "placement_support": "The college offers placement services including aptitude training, coding sessions, and soft-skill development.",

            "internship": "The college provides assistance for internships.",

            "hostel": "Separate hostels are available for boys and girls. Hostel life is generally moderate in terms of rules and discipline.",

            "hostel_outing": "Outing permission is required for hostel students.",

            "hostel_visitors": "Day scholars are not allowed to visit hostels.",

            "dress_code": "A formal dress code is compulsory for both boys and girls.",

            "mobile_policy": "Mobile phones must be kept silent or switched off inside classrooms.",

            "late_entry": "Late entry into college is not permitted.",

            "biometric": "Biometric attendance is not used.",

            "clubs_technical": "Technical and innovation clubs include GDG, IEEE, ThinkerHub, IEDC, and μLearn.",

            "clubs_cultural": "The college supports cultural, arts, and extracurricular activities through student associations.",

            "nss": "The college has an active National Service Scheme (NSS) unit.",

            "canteen": "The campus has one main canteen and two kiosks for food and refreshments.",

            "wifi": "Wi-Fi facilities are available for students on campus.",

            "library": "The Central Library contains academic books, journals, and digital resources. It is open from 8:00 AM to 6:00 PM on working days.",

            "bus": "College buses operate across Ernakulam, Idukki, and Kottayam districts.",

            "exam_results": "Internal marks can be checked through the ETLAB software. University results are published by KTU.",

            "revaluation": "Revaluation and scrutiny procedures are supported as per university guidelines.",

            "exam_help": "For exam-related issues, students should contact their tutors or assistant tutors.",

            "parent_updates": "Parents are informed about student attendance and academic performance.",

            "grievance": "Students can submit grievances to the Grievance Redressal Cell through official channels.",

            "ragging": "The college follows a strict anti-ragging policy.",

            "contact": "Phone: 0485-2822363, 2822364. Email: office@vjcet.org / principal@vjcet.org. Website: www.vjcet.org",

            "auditiorium": "The college has an auditorium that is used for major events, programs, and gatherings.",

            "seminar_halls": "The campus has more than four seminar halls used for workshops, talks, and department events.",

            "medical_facility": "A medical room with first-aid facilities is available on campus for emergencies.",

            "security": "Security personnel are available at the main gate and across the campus.",

            "lifts": "Elevator (lift) facilities are not available in academic blocks.",

            "labs_access": "Computer laboratories may be accessed beyond class hours with permission.",

            "wifi_coverage": "Campus-wide Wi-Fi connectivity is available for students.",

            "personal_laptops": "Personal laptops are not allowed inside computer labs.",

            "printing": "Printing and xerox facilities are available only through reprography units.",

            "sports_outdoor": "Outdoor sports facilities such as football and cricket are available on campus.",

            "sports_indoor": "Indoor games facilities are available for students.",

            "gym": "A gym and fitness center is available on campus.",

            "sports_period": "Sports period is included as part of the academic schedule.",

            "bus_missed": "If a student misses the college bus, there is no alternative transport facility provided by the college.",

            "campus_exit": "Students are allowed to leave the campus during breaks only with proper permission.",

            "gate_pass": "A gate pass system is followed for students leaving the campus during working hours.",

            "women_cell": "A Women’s Cell / Internal Complaints Committee (ICC) is active in the college.",

            "anti_ragging_contact": "An Anti-Ragging Committee is present to address and handle ragging-related complaints.",

            "emergency_contact": "In case of emergencies or disciplinary issues, students should contact their tutors, assistant tutors, or Head of the Department (HOD).",

            "campus_culture": "The overall campus environment is friendly and student-supportive.",

            "fest_days": "Fest days may be conducted as full-day or half-day programs depending on the schedule.",

            "student_events": "Students are allowed to organize events with proper approval from the college authorities.",

            "reprography": "Reprography (xerox and printing) facilities are available in both B Block and C Block for students.",
            
            "college_office": "The college office is located in C Block.",

            "principal_office": "The Principal’s office is located in C Block near the college office.",

            "placement_office": "The Placement Cell office is located in C Block.",

            "academic_section": "An academic/student affairs section is available to handle student-related matters.",

            "stationery": "A stationery store is available on campus for student needs.",

            "lab_lock_policy": "Department laboratories are usually locked outside class hours.",

            "lab_access_projects": "Students are allowed to access labs for projects and practice with proper permission.",

            "after_hours_lab": "Departments allow after-hours lab work with prior approval.",

            "innovation_rooms": "There are no separate research or innovation rooms apart from regular department facilities.",

            "dress_code_fine": "There is no fine imposed for dress code violations.",

            "discipline_mobile": "If a student uses a mobile phone in class, it may be confiscated for one day and returned the next day.",

            "discipline_process": "For disciplinary actions, students are required to submit an apology letter.",

            "lateral_entry": "Lateral entry admissions are available.",

            "orientation": "An orientation program is conducted for newly admitted students.",

            "parent_orientation": "Parents are not required to attend the orientation program.",

            "id_card": "Students are first issued a temporary ID card, followed by a permanent ID card later.",

            "lab_exams": "Practical examinations are conducted both internally and externally.",

            "lab_exam_strictness": "Laboratory examinations are conducted strictly.",

            "lab_record": "Submission of lab records is mandatory for practical examinations.",

            "drinking_water": "Drinking water facilities are available across the campus.",

            "washrooms": "Washrooms are available in every block and on every floor.",

            "charging_points": "Charging points are available for student use.",

            "lost_and_found": "A lost-and-found system is followed on campus.",

            "wheelchair_access": "Wheelchair accessibility information is not specified.",
            
            "periods_per_day": "There are 7 periods per day in the regular timetable.",

            "period_duration": "Each period lasts approximately 50 to 55 minutes.",

            "morning_prayer": "The college day begins with a morning prayer.",

            "lunch_break": "Lunch break is from 12:45 PM to 1:35 PM.",

            "bell_system": "College bells are strictly followed for all periods and breaks.",

            "faculty_approach": "Students are allowed to approach teachers outside class hours for academic support.",

            "faculty_nature": "Faculty members are generally supportive towards students.",

            "extra_classes": "Extra classes are conducted, especially before exams when required.",

            "online_classes": "Online classes may be conducted during emergencies or special situations.",

            "assignments": "Assignments may be submitted in handwritten or printed format as instructed.",

            "late_submission": "Late submission of assignments is generally not accepted.",

            "internal_marks": "Late submission of assignments can negatively affect internal marks.",

            "lab_records": "Lab records are evaluated strictly and must be submitted on time.",

            "fest_classes": "Regular classes are usually suspended during technical and arts fests.",

            "holiday_updates": "Holiday and academic updates are communicated through WhatsApp groups, notice boards, and the ETLAB portal.",

            "compensatory_classes": "Compensatory classes may be conducted to cover missed syllabus.",

            "hostel_mess_rules": "Hostel mess timings are strictly followed.",

            "hostel_outside_food": "Outside food is generally not allowed inside hostels.",

            "hostel_wifi": "Hostel Wi-Fi connectivity is generally good.",

            "hostel_study_hours": "Study hours are enforced in hostels.",

            "free_hours": "Students are allowed to sit anywhere on campus during free hours.",

            "pda_policy": "Public display of affection (PDA) is not permitted on campus.",

            "outsiders": "Outsiders or friends are not allowed inside the campus without permission.",

            "photography": "Photography is allowed on campus, subject to college guidelines.",

            "exam_reporting_time": "Students are advised to reach the examination hall at least 15 minutes before the exam starts.",

            "hall_ticket": "Printed hall tickets are required for examinations.",

            "exam_id_card": "Carrying a valid college ID card is mandatory during examinations.",

            "exam_bags": "Bags are not allowed inside the examination hall.",

            "exam_late_entry": "Late entry into the exam hall requires permission from the exam coordinator.",

            "internal_weightage": "Internal assessment weightage depends on the batch and university regulations.",

            "internal_marks_display": "Internal marks are published at the end of the semester.",

            "internal_correction": "Students can request correction of internal marks if required.",

            "internal_approval": "Internal marks are finalized and approved by class tutors.",

            "mini_project": "Mini-projects are compulsory as part of the curriculum.",

            "final_year_project": "Final-year projects may be done individually or as a team, depending on department guidelines.",

            "external_guide": "Students are allowed to choose external project guides with permission.",

            "project_reviews": "Project reviews are conducted periodically.",

            "project_presentation": "Project presentations are conducted in a formal manner.",

            "placement_cgpa": "A minimum CGPA of 6 is generally required to attend placement drives.",

            "placement_optional": "Students may choose to skip placements if they wish.",

            "placement_attendance": "Attendance is compulsory for placement training sessions.",

            "placement_arrears": "Companies generally prefer candidates with no history of backlogs.",

            "placement_binding": "Placement offers are considered binding once accepted.",

            "fee_payment": "Fees can be paid both online and directly at the college office.",

            "late_fee": "Late fee payment may attract fines as per college rules.",

            "exam_fee": "Examination fees are separate from tuition fees.",

            "fee_refund": "Fees are generally non-refundable if a student leaves mid-year.",

            "issue_escalation_1": "Students should first approach their tutor or Head of the Department (HOD) for academic issues.",

            "issue_escalation_2": "If unresolved, the issue can be escalated to higher authorities.",

            "final_authority": "The Vice Principal or Principal is the final authority in serious matters.",

            "alumni": "The college has an active alumni association.",

            "alumni_support": "Alumni assist students with placements and internship opportunities.",

            "certificates": "Experience and conduct certificates are issued after graduation.",

            "certificate_timeline": "Certificates are issued after graduation following the college process.",

            "exam_calculator": "Scientific calculators are allowed in examinations as per subject requirements.",

            "exam_smart_devices": "Smart watches and smart bands are not allowed inside examination halls.",

            "exam_malpractice": "If malpractice is suspected, the case is reviewed and appropriate action is taken by the authorities.",

            "exam_rough_sheets": "Rough sheets are not provided during examinations.",

            "exam_exit": "Students are allowed to leave the examination hall only after the minimum time limit is completed.",

            "attendance_type": "Attendance is calculated subject-wise.",

            "attendance_proxy": "Proxy attendance cases are taken seriously and strict action is initiated.",

            "attendance_extra_classes": "Attendance may be improved through extra classes when permitted.",

            "attendance_freeze": "Attendance is frozen before examinations as per academic rules.",

            "lab_exam_uniform": "Uniform is mandatory during lab examinations.",

            "lab_coat": "Lab coats are not mandatory unless specified by the department.",

            "lab_exam_miss": "If a student misses a lab exam, they should contact the tutor or the concerned faculty member.",

            "lab_viva": "Viva voce examinations are conducted strictly.",

            "lab_repeat": "Students may be allowed to redo experiments for improvement if permitted.",

            "placement_dress": "Formal dress is mandatory during placement drives.",

            "placement_multiple": "Students are allowed to attend multiple company placement drives.",

            "placement_reject": "Rejecting a placement offer does not result in immediate action.",

            "placement_mode": "Placement drives may be conducted in online, offline, or hybrid mode.",

            "hostel_rules": "Hostellers generally have stricter rules compared to day scholars.",

            "day_scholar_timing": "Day scholars are allowed to stay on campus until 6:00 PM.",

            "hostel_weekend": "Hostellers are allowed to go home on weekends with permission.",

            "hostel_parent_info": "Parents are informed regarding hostel-related issues.",

            "power_backup": "The campus has power backup facilities such as generators.",

            "internet_outage": "During internet outages, services resume once connectivity is restored.",

            "evacuation_drill": "Emergency evacuation drills are conducted on campus.",

            "bunking": "Bunking classes is generally discouraged but may occur.",

            "surprise_tests": "Surprise tests may be conducted by faculty.",

            "faculty_punctuality": "Faculty members are generally punctual.",

            "ragging_status": "The campus maintains a zero-tolerance policy towards ragging.",

            "senior_support": "Senior students are generally helpful and supportive towards juniors."
        };


        // --- AUTH & NAVIGATION ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            // Only proceed if disclaimer is already accepted
            if (isDisclaimerAccepted) {
                navigateBasedOnAuth();
            }
        });

        // Expose function to window for the button click
        window.acceptDisclaimer = function() {
            isDisclaimerAccepted = true;
            document.getElementById('disclaimer-view').style.display = 'none';
            document.getElementById('main-card').classList.remove('disclaimer-active');
            navigateBasedOnAuth();
        };

        function navigateBasedOnAuth() {
            if (currentUser) {
                showView('chat-view', 'chat-active');
                
                // Update Header
                const email = sessionStorage.getItem('userEmail') || "Visitor";
                const name = extractName(email);
                const greeting = getGreeting();
                const headerTitle = document.getElementById('header-title');
                if(headerTitle) {
                    headerTitle.innerHTML = `<span class="status-dot"></span> ${greeting}, ${name}`;
                }
            } else {
                showView('auth-view', 'auth-active');
                resetAuthUI();
            }
        }

        function showView(viewId, cardClass) {
            const card = document.getElementById('main-card');
            const authView = document.getElementById('auth-view');
            const chatView = document.getElementById('chat-view');
            const disclaimerView = document.getElementById('disclaimer-view');

            // Hide everything first
            authView.style.display = 'none';
            chatView.style.display = 'none';
            disclaimerView.style.display = 'none';

            card.className = `glass-card ${cardClass}`;
            document.getElementById(viewId).style.display = 'flex';
            setTimeout(() => document.getElementById(viewId).style.opacity = '1', 50);
        }

        // --- OTP LOGIC ---
        window.handleAuthAction = async function() {
            if (!isOtpSent) requestOTP();
            else verifyOTP();
        };

        function requestOTP() {
            const emailInput = document.getElementById('email');
            const email = emailInput.value.trim().toLowerCase();
            const errorEl = document.getElementById('error-msg');
            const btn = document.getElementById('btn-action');
            const btnText = document.getElementById('btn-text');
            const spinner = document.getElementById('btn-spinner');

            errorEl.style.display = "none";
            emailInput.style.borderColor = "var(--glass-border)";

            if (!email.endsWith('@vjcet.org')) {
                errorEl.innerText = "Restricted: Use @vjcet.org only.";
                errorEl.style.display = "block";
                return;
            }

            btnText.style.display = "none";
            spinner.style.display = "block";
            btn.disabled = true;

            currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
            
            const now = new Date();
            now.setMinutes(now.getMinutes() + 15);
            
            const templateParams = {
                to_email: email, 
                otp_code: currentOTP,
                time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };

            emailjs.send(emailJsConfig.serviceID, emailJsConfig.templateID, templateParams)
                .then(() => {
                    spinner.style.display = "none";
                    btn.disabled = false;
                    isOtpSent = true;
                    emailInput.disabled = true;
                    document.getElementById('otp-section').style.display = "block";
                    document.getElementById('btn-guest').style.display = "none";
                    btnText.innerText = "Verify & Enter";
                    btnText.style.display = "block";
                    document.querySelector('.otp-field').focus();
                }).catch((err) => {
                    spinner.style.display = "none";
                    btn.disabled = false;
                    btnText.style.display = "block";
                    alert("Email Failed (" + err.status + ").\nFALLBACK CODE: " + currentOTP);
                    // Fallback flow
                    isOtpSent = true;
                    emailInput.disabled = true;
                    document.getElementById('otp-section').style.display = "block";
                    document.getElementById('btn-guest').style.display = "none";
                    btnText.innerText = "Verify & Enter";
                });
        }

        async function verifyOTP() {
            const otpFields = document.querySelectorAll('.otp-field');
            const enteredCode = Array.from(otpFields).map(f => f.value).join('');
            
            if (enteredCode === currentOTP) {
                sessionStorage.setItem('userEmail', document.getElementById('email').value);
                try { await signInAnonymously(auth); } 
                catch (err) { alert("Login Failed: " + err.message); }
            } else {
                otpFields.forEach(f => { f.value = ""; f.style.borderColor = "#ff6b6b"; });
                otpFields[0].focus();
            }
        }

        window.handleGuestLogin = async function() {
            sessionStorage.setItem('userEmail', 'Visitor');
            try { await signInAnonymously(auth); } 
            catch (error) { alert("Enable Anonymous Auth in Firebase Console."); }
        };

        window.handleLogout = () => {
            signOut(auth).then(() => { 
                sessionStorage.removeItem('userEmail');
                location.reload(); 
            });
        };

        function resetAuthUI() {
            isOtpSent = false;
            currentOTP = null;
            document.getElementById('email').value = "";
            document.getElementById('email').disabled = false;
            document.getElementById('otp-section').style.display = "none";
            document.getElementById('btn-text').innerText = "Send Verification Code";
            document.getElementById('btn-guest').style.display = "block";
            document.getElementById('error-msg').style.display = "none";
            document.querySelectorAll('.otp-field').forEach(f => { f.value = ""; f.style.borderColor = "var(--glass-border)"; });
            document.getElementById('btn-spinner').style.display = "none";
            document.getElementById('btn-action').disabled = false;
        }

        // --- OTP AUTO-FOCUS ---
        const otpInputs = document.querySelectorAll('.otp-field');
        otpInputs.forEach((field, index) => {
            field.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && index < otpInputs.length - 1) otpInputs[index + 1].focus();
            });
            field.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) otpInputs[index - 1].focus();
            });
        });

        // --- CHAT LOGIC WITH ANIMATION ---
        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            appendMessage(text, 'user');
            input.value = ''; 
            
            document.getElementById('typing-indicator').style.display = 'flex';

            const responseText = await callGemini(text);
            
            document.getElementById('typing-indicator').style.display = 'none';
            typeWriterMessage(responseText);
        };

        function appendMessage(text, type) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function typeWriterMessage(text) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'msg bot';
            box.appendChild(div);
            
            let i = 0;
            const speed = 15;
            
            function type() {
                if (i < text.length) {
                    div.innerHTML += text.charAt(i);
                    i++;
                    box.scrollTop = box.scrollHeight;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        // --- MODAL & MENU LOGIC ---
        window.toggleSettings = () => {
            openModal('settings-modal');
        };

        window.closeSettingsModal = () => {
            closeModal('settings-modal');
        };

        window.openReportModal = () => {
            closeModal('settings-modal');
            setTimeout(() => openModal('report-modal'), 300);
        };

        window.closeReportModal = () => {
            closeModal('report-modal');
        };

        window.submitReport = () => {
            const issue = document.getElementById('report-text').value.trim();
            if(!issue) return;
            
            alert("Thank you! Your feedback has been recorded.");
            document.getElementById('report-text').value = "";
            closeReportModal();
        };

        window.triggerLogoutConfirmation = () => {
            closeModal('settings-modal');
            setTimeout(() => openModal('logout-modal'), 300);
        };

        window.closeLogoutModal = () => {
            closeModal('logout-modal');
        };

        window.confirmLogout = () => {
            window.handleLogout();
        };

        // Generic Modal Helpers
        function openModal(id) {
            const modal = document.getElementById(id);
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function callGemini(query) {
            const userEmail = sessionStorage.getItem('userEmail');
            let contextData = Object.values(collegeKnowledgeBase).join("\n- ");
            
            // Check specific user
            if (userEmail && userEmail.toLowerCase() === 'abhinav24rg307@vjcet.org') {
                 contextData += `\n\n--- SPECIFIC STUDENT DATA FOR ${userEmail} ---\n` + JSON.stringify(specificStudentData, null, 2);
            }

            const system = `You are AskCampus, the official AI assistant for Viswajyothi College of Engineering and Technology (VJCET).
            
            OFFICIAL CAMPUS INFORMATION:
            - ${contextData}
            
            INSTRUCTIONS:
            1. Answer the user's question strictly based on the OFFICIAL CAMPUS INFORMATION provided above.
            2. Keep your response SHORT, concise, and to the point.
            3. If the answer is not found in the provided information, simply state that you do not have that specific detail and suggest contacting the college office.
            4. Do not hallucinate or make up information.
            5. Do not simply list keywords; provide natural, human-like answers.`;
            
            try {
                // UPDATED: Using gemini-2.5-flash-preview-09-2025
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{parts:[{text: query}]}], systemInstruction: {parts:[{text: system}]} })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "I didn't quite get that.";
            } catch (e) { return "I'm having trouble connecting right now."; }
        }
    </script>
</body>
</html>
